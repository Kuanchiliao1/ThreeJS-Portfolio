import{walkSync as Or,ELEMENT_NODE as nr,TEXT_NODE as Ir,render as zr}from"../index.js";import{matches as Lr}from"../selector.js";var j="comm",K="rule",V="decl";var or="@import";var ir="@keyframes";var cr=Math.abs,I=String.fromCharCode;function W(r){return r.trim()}function z(r,e,t){return r.replace(e,t)}function ur(r,e){return r.indexOf(e)}function F(r,e){return r.charCodeAt(e)|0}function O(r,e,t){return r.slice(e,t)}function g(r){return r.length}function N(r){return r.length}function R(r,e){return e.push(r),r}var Y=1,M=1,pr=0,x=0,h=0,C="";function B(r,e,t,n,s,o,u){return{value:r,root:e,parent:t,type:n,props:s,children:o,line:Y,column:M,length:u,return:""}}function fr(){return h}function lr(){return h=x>0?F(C,--x):0,M--,h===10&&(M=1,Y--),h}function b(){return h=x<pr?F(C,x++):0,M++,h===10&&(M=1,Y++),h}function A(){return F(C,x)}function L(){return x}function G(r,e){return O(C,r,e)}function J(r){switch(r){case 0:case 9:case 10:case 13:case 32:return 5;case 33:case 43:case 44:case 47:case 62:case 64:case 126:case 59:case 123:case 125:return 4;case 58:return 3;case 34:case 39:case 40:case 91:return 2;case 41:case 93:return 1}return 0}function hr(r){return Y=M=1,pr=g(C=r),x=0,[]}function mr(r){return C="",r}function Z(r){return W(G(x-1,Q(r===91?r+2:r===40?r+1:r)))}function gr(r){for(;(h=A())&&h<33;)b();return J(r)>2||J(h)>3?"":" "}function xr(r,e){for(;--e&&b()&&!(h<48||h>102||h>57&&h<65||h>70&&h<97););return G(r,L()+(e<6&&A()==32&&b()==32))}function Q(r){for(;b();)switch(h){case r:return x;case 34:case 39:r!==34&&r!==39&&Q(h);break;case 40:r===41&&Q(r);break;case 92:b();break}return x}function br(r,e){for(;b()&&r+h!==47+10;)if(r+h===42+42&&A()===47)break;return"/*"+G(e,x-1)+"*"+I(r===47?r:b())}function wr(r){for(;!J(A());)b();return G(r,x)}function rr(r){return mr(H("",null,null,null,[""],r=hr(r),0,[0],r))}function H(r,e,t,n,s,o,u,a,i){for(var p=0,f=0,c=u,w=0,E=0,S=0,d=1,$=1,y=1,m=0,T="",D=s,k=o,v=n,l=T;$;)switch(S=m,m=b()){case 40:if(S!=108&&F(l,c-1)==58){ur(l+=z(Z(m),"&","&\f"),"&\f")!=-1&&(y=-1);break}case 34:case 39:case 91:l+=Z(m);break;case 9:case 10:case 13:case 32:l+=gr(S);break;case 92:l+=xr(L()-1,7);continue;case 47:switch(A()){case 42:case 47:R(kr(br(b(),L()),e,t),i);break;default:l+="/"}break;case 123*d:a[p++]=g(l)*y;case 125*d:case 59:case 0:switch(m){case 0:case 125:$=0;case 59+f:E>0&&g(l)-c&&R(E>32?dr(l+";",n,t,c-1):dr(z(l," ","")+";",n,t,c-2),i);break;case 59:l+=";";default:if(R(v=Er(l,e,t,p,f,s,a,T,D=[],k=[],c),o),m===123)if(f===0)H(l,e,v,v,D,o,c,a,k);else switch(w){case 100:case 109:case 115:H(r,v,v,n&&R(Er(r,v,v,0,0,s,a,T,s,D=[],c),k),s,k,c,a,n?D:k);break;default:H(l,v,v,v,[""],k,0,a,k)}}p=f=E=0,d=y=1,T=l="",c=u;break;case 58:c=1+g(l),E=S;default:if(d<1){if(m==123)--d;else if(m==125&&d++==0&&lr()==125)continue}switch(l+=I(m),m*d){case 38:y=f>0?1:(l+="\f",-1);break;case 44:a[p++]=(g(l)-1)*y,y=1;break;case 64:A()===45&&(l+=Z(b())),w=A(),f=c=g(T=l+=wr(L())),m++;break;case 45:S===45&&g(l)==2&&(d=0)}}return o}function Er(r,e,t,n,s,o,u,a,i,p,f){for(var c=s-1,w=s===0?o:[""],E=N(w),S=0,d=0,$=0;S<n;++S)for(var y=0,m=O(r,c+1,c=cr(d=u[S])),T=r;y<E;++y)(T=W(d>0?w[y]+" "+m:z(m,/&\f/g,w[y])))&&(i[$++]=T);return B(r,e,t,s===0?K:a,i,p,f)}function kr(r,e,t){return B(r,e,t,j,I(fr()),O(r,2,-2),0)}function dr(r,e,t,n){return B(r,e,t,V,O(r,0,n),O(r,n+1,-1),n)}function U(r,e){for(var t="",n=N(r),s=0;s<n;s++)t+=e(r[s],s,r,e)||"";return t}function yr(r,e,t,n){switch(r.type){case or:case V:return r.return=r.return||r.value;case j:return"";case ir:return r.return=r.value+"{"+U(r.children,n)+"}";case K:r.value=r.props.join(",")}return g(t=U(r.children,n))?r.return=r.value+"{"+t+"}":""}function tr(r){var e=N(r);return function(t,n,s,o){for(var u="",a=0;a<e;a++)u+=r[a](t,n,s,o)||"";return u}}var X={attribute:/\[\s*(?:(?<namespace>\*|[-\w]*)\|)?(?<name>[-\w\u{0080}-\u{FFFF}]+)\s*(?:(?<operator>\W?=)\s*(?<value>.+?)\s*(?<caseSensitive>[iIsS])?\s*)?\]/gu,id:/#(?<name>(?:[-\w\u{0080}-\u{FFFF}]|\\.)+)/gu,class:/\.(?<name>(?:[-\w\u{0080}-\u{FFFF}]|\\.)+)/gu,comma:/\s*,\s*/g,combinator:/\s*[\s>+~]\s*/g,"pseudo-element":/::(?<name>[-\w\u{0080}-\u{FFFF}]+)(?:\((?<argument>¶+)\))?/gu,"pseudo-class":/:(?<name>[-\w\u{0080}-\u{FFFF}]+)(?:\((?<argument>¶+)\))?/gu,type:/(?:(?<namespace>\*|[-\w]*)\|)?(?<name>[-\w\u{0080}-\u{FFFF}]+)|\*/gu},vr=new Set(["pseudo-class","pseudo-element"]),Fr=new Set([...vr,"attribute"]),Nr=new Set(["combinator","comma"]),Sr=new Set(["not","is","where","has","matches","-moz-any","-webkit-any","nth-child","nth-last-child"]),Tr={"nth-child":/(?<index>[\dn+-]+)\s+of\s+(?<subtree>.+)/};Sr["nth-last-child"]=Tr["nth-child"];var q=Object.assign({},X);function Rr(r,e){let t="",n=[];for(;e<r.length;e++){let s=r[e];if(s==="(")n.push(s);else if(s===")"){if(!(n.length>0))throw new Error("Closing paren without opening paren at "+e);n.pop()}if(t+=s,n.length===0)return t}throw new Error("Opening paren without closing paren")}function Mr(r,e){if(!r)return[];var t=[r];for(var n in e){let i=e[n];for(var s=0;s<t.length;s++){var o=t[s];if(typeof o=="string"){i.lastIndex=0;var u=i.exec(o);if(u){let p=u.index-1,f=[],c=u[0],w=o.slice(0,p+1);w&&f.push(w),f.push({type:n,content:c,...u.groups});let E=o.slice(p+c.length+1);E&&f.push(E),t.splice(s,1,...f)}}}}let a=0;for(let i=0;i<t.length;i++){let p=t[i],f=p.length||p.content.length;typeof p=="object"&&(p.pos=[a,a+f],Nr.has(p.type)&&(p.content=p.content.trim()||" ")),a+=f}return t}function Cr(r){if(!r)return null;r=r.trim();let e=[];r=r.replace(/(['"])(\\\1|.)+?\1/g,(a,i,p,f)=>(e.push({str:a,start:f}),i+"\xA7".repeat(p.length)+i));let t,n=[],s=0;for(;(t=r.indexOf("(",s))>-1;){let a=Rr(r,t);n.push({str:a,start:t}),r=r.substring(0,t)+"("+"\xB6".repeat(a.length-2)+")"+r.substring(t+a.length),s=t+a.length}let o=Mr(r,X);function u(a,i,p){for(let f of a)for(let c of o)if(p.has(c.type)&&c.pos[0]<f.start&&f.start<c.pos[1]){let w=c.content;if(c.content=c.content.replace(i,f.str),c.content!==w){q[c.type].lastIndex=0;let E=q[c.type].exec(c.content).groups;Object.assign(c,E)}}}return u(n,/\(¶+\)/,vr),u(e,/(['"])§+?\1/,Fr),o}function P(r,{list:e=!0}={}){if(e&&r.find(t=>t.type==="comma")){let t=[],n=[];for(let s=0;s<r.length;s++)if(r[s].type==="comma"){if(n.length===0)throw new Error("Incorrect comma at "+s);t.push(P(n,{list:!1})),n.length=0}else n.push(r[s]);if(n.length===0)throw new Error("Trailing comma");return t.push(P(n,{list:!1})),{type:"list",list:t}}for(let t=r.length-1;t>=0;t--){let n=r[t];if(n.type==="combinator"){let s=r.slice(0,t),o=r.slice(t+1);return{type:"complex",combinator:n.content,left:P(s),right:P(o)}}}return r.length===0?null:r.length===1?r[0]:{type:"compound",list:[...r]}}function _(r,e,t,n){if(r){if(r.type==="complex")_(r.left,e,t,r),_(r.right,e,t,r);else if(r.type==="compound")for(let s of r.list)_(s,e,t,r);else r.subtree&&t&&t.subtree&&_(r.subtree,e,t,r);e(r,n)}}function er(r,{recursive:e=!0,list:t=!0}={}){let n=Cr(r);if(!n)return null;let s=P(n,{list:t});return e&&_(s,o=>{if(o.type==="pseudo-class"&&o.argument&&Sr.has(o.name)){let u=o.argument,a=Tr[o.name];if(a){let i=a.exec(u);if(!i)return;Object.assign(o,i.groups),u=i.groups.subtree}u&&(o.subtree=er(u,{recursive:!0,list:!0}))}}),s}q["pseudo-element"]=RegExp(X["pseudo-element"].source.replace("(?<argument>\xB6+)","(?<argument>.+?)"),"gu"),q["pseudo-class"]=RegExp(X["pseudo-class"].source.replace("(?<argument>\xB6+)","(?<argument>.+)"),"gu");function Ur(r={}){return async e=>{let t=r.hash??Vr(await zr(e)),n=[],s=!1,o=new Set,u=new Set;Or(e,a=>{if(a.type===nr&&a.name==="style"&&(!r.attribute||_r(a,r.attribute))){s=!0,r.attribute&&delete a.attributes[r.attribute];for(let i of jr(a.children[0].value))o.add(i)}a.type===nr&&u.add(a)}),s&&Or(e,a=>{a.type===nr&&(n.push(()=>$r(a,t,o)),a.name==="style"&&n.push(()=>{a.children=a.children.map(i=>(i.type!==Ir||(i.value=Dr(i.value,t),i.value===""&&(a.parent.children=a.parent.children.filter(p=>p!==a))),i))}))});for(let a of n)a();return e}}var Pr=new Set(["base","font","frame","frameset","head","link","meta","noframes","noscript","script","style","title"]);function _r(r,e){return e in r.attributes?r.attributes[e]!=="false":!1}function $r(r,e,t){let{name:n}=r;if(!!n&&!(n.length<1)&&!Pr.has(n)&&!r.attributes["data-scope"]){for(let s of t)if(Lr(r,s)){r.attributes["data-scope"]=e;return}}}function Ar(r,e){let t=er(r),n=s=>{switch(s.type){case"pseudo-class":return s.name==="root"?s.content:s.name==="global"?s.argument:`${s.content}:where([data-scope="${e}"])`;case"compound":return`${r}:where([data-scope="${e}"])`;case"complex":{let{left:o,right:u,combinator:a}=s;return`${n(o)}${a}${n(u)}`}case"list":return s.list.map(o=>n(o)).join(" ");default:return`${s.content}:where([data-scope="${e}"])`}};return n(t)}function Dr(r,e){return U(rr(r),tr([t=>{t.type==="rule"&&(Array.isArray(t.props)?t.props=t.props.map(n=>Ar(n,e)):t.props=Ar(t.props,e))},yr]))}function jr(r){let e=new Set;return U(rr(r),tr([t=>{if(t.type==="rule")if(Array.isArray(t.props))for(let n of t.props)e.add(n);else e.add(t.props)}])),Array.from(e)}var ar="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXY",sr=ar.length;function Kr(r){let e=0;if(r.length===0)return e;for(let t=0;t<r.length;t++){let n=r.charCodeAt(t);e=(e<<5)-e+n,e=e&e}return e}function Vr(r){let e,t="",n=Kr(r),s=n<0?"Z":"";for(n=Math.abs(n);n>=sr;)e=n%sr,n=Math.floor(n/sr),t=ar[e]+t;return n>0&&(t=ar[n]+t),s+t}export{Ur as default};
/**
 * shorthash - https://github.com/bibig/node-shorthash
 *
 * @license
 *
 * (The MIT License)
 *
 * Copyright (c) 2013 Bibig <bibig@me.com>
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */

{"version":3,"sources":["../../../../src/checkers/vueTsc/prepareVueTsc.ts"],"sourcesContent":["import fs from 'fs'\nimport { createRequire } from 'module'\nimport path, { dirname } from 'path'\nimport { fileURLToPath } from 'url'\nconst _require = createRequire(import.meta.url)\n\n// isomorphic __dirname https://antfu.me/posts/isomorphic-dirname\nconst _filename = fileURLToPath(import.meta.url)\nconst _dirname = dirname(_filename)\n\nlet proxyPath: string\nlet createProgramFunction: string\ntry {\n  // vue-tsc exposes the proxy in vue-tsc/out/index after v1.0.14\n  proxyPath = _require.resolve('vue-tsc/out/index')\n  createProgramFunction = 'createProgram'\n} catch (e) {\n  // vue-tsc exposes the proxy in vue-tsc/out/proxy before v1.0.14\n  proxyPath = _require.resolve('vue-tsc/out/proxy')\n  createProgramFunction = 'createProgramProxy'\n}\n\nconst textToReplace: { target: string; replacement: string }[] = [\n  {\n    target: `ts.supportedTSExtensions = [[\".ts\", \".tsx\", \".d.ts\"], [\".cts\", \".d.cts\"], [\".mts\", \".d.mts\"]];`,\n    replacement: `ts.supportedTSExtensions = [[\".ts\", \".tsx\", \".d.ts\"], [\".cts\", \".d.cts\"], [\".mts\", \".d.mts\"], [\".vue\"]];`,\n  },\n  {\n    target: `ts.supportedJSExtensions = [[\".js\", \".jsx\"], [\".mjs\"], [\".cjs\"]];`,\n    replacement: `ts.supportedJSExtensions = [[\".js\", \".jsx\"], [\".mjs\"], [\".cjs\"], [\".vue\"]];`,\n  },\n\n  {\n    target: `var allSupportedExtensions = [[\".ts\", \".tsx\", \".d.ts\", \".js\", \".jsx\"], [\".cts\", \".d.cts\", \".cjs\"], [\".mts\", \".d.mts\", \".mjs\"]];`,\n    replacement: `var allSupportedExtensions = [[\".ts\", \".tsx\", \".d.ts\", \".js\", \".jsx\"], [\".cts\", \".d.cts\", \".cjs\"], [\".mts\", \".d.mts\", \".mjs\"], [\".vue\"]];`,\n  },\n\n  // proxy createProgram apis\n  {\n    target: `function createIncrementalProgram(_a) {`,\n    replacement: `function createIncrementalProgram(_a) { console.error('incremental mode is not yet supported'); throw 'incremental mode is not yet supported';`,\n  },\n  {\n    target: `function createProgram(rootNamesOrOptions, _options, _host, _oldProgram, _configFileParsingDiagnostics) {`,\n    replacement: `function createProgram(rootNamesOrOptions, _options, _host, _oldProgram, _configFileParsingDiagnostics) { return require(${JSON.stringify(\n      proxyPath\n    )}).${createProgramFunction}(...arguments);`,\n  },\n  {\n    target: `ts.executeCommandLine(ts.sys, ts.noop, ts.sys.args);`,\n    replacement: `module.exports = ts`,\n  },\n]\n\nexport function prepareVueTsc() {\n  // 1. copy typescript to folder\n  const targetTsDir = path.resolve(_dirname, 'typescript-vue-tsc')\n  const vueTscFlagFile = path.resolve(targetTsDir, 'vue-tsc-resolve-path')\n\n  let shouldPrepare = true\n  const targetDirExist = fs.existsSync(targetTsDir)\n  if (targetDirExist) {\n    try {\n      const targetTsVersion = _require(path.resolve(targetTsDir, 'package.json')).version\n      const currTsVersion = _require('typescript/package.json').version\n      // check fixture versions before re-use\n      if (\n        targetTsVersion === currTsVersion &&\n        fs.existsSync(vueTscFlagFile) &&\n        fs.readFileSync(vueTscFlagFile, 'utf8') === proxyPath\n      ) {\n        shouldPrepare = true\n      }\n    } catch {\n      shouldPrepare = true\n    }\n  }\n\n  if (shouldPrepare) {\n    rimraf(targetTsDir)\n    fs.mkdirSync(targetTsDir)\n    const sourceTsDir = path.resolve(_require.resolve('typescript'), '../..')\n    copyDirRecursively(sourceTsDir, targetTsDir)\n    fs.writeFileSync(vueTscFlagFile, proxyPath)\n\n    // 2. sync modification of lib/tsc.js with vue-tsc\n    const tscJs = _require.resolve(path.resolve(targetTsDir, 'lib/tsc.js'))\n    modifyFileText(tscJs, textToReplace)\n  }\n\n  return { targetTsDir: targetTsDir }\n}\n\nfunction modifyFileText(\n  filePath: string,\n  textToReplace: { target: string; replacement: string }[]\n) {\n  const text = fs.readFileSync(filePath, 'utf8')\n  let newText = text\n  for (const { target, replacement } of textToReplace) {\n    newText = newText.replace(target, replacement)\n  }\n  fs.writeFileSync(filePath, newText)\n}\n\nfunction copyDirRecursively(src: string, dest: string) {\n  const files = fs.readdirSync(src, { withFileTypes: true })\n  for (const file of files) {\n    const srcPath = path.join(src, file.name)\n    const destPath = path.join(dest, file.name)\n    if (file.isDirectory()) {\n      fs.mkdirSync(destPath, { recursive: true })\n      copyDirRecursively(srcPath, destPath)\n    } else {\n      fs.copyFileSync(srcPath, destPath)\n    }\n  }\n}\n\n/**\n * https://stackoverflow.com/a/42505874\n */\nfunction rimraf(dir_path: string) {\n  if (fs.existsSync(dir_path)) {\n    fs.readdirSync(dir_path).forEach((entry) => {\n      const entry_path = path.join(dir_path, entry)\n      if (fs.lstatSync(entry_path).isDirectory()) {\n        rimraf(entry_path)\n      } else {\n        fs.unlinkSync(entry_path)\n      }\n    })\n    fs.rmdirSync(dir_path)\n  }\n}\n"],"mappings":"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","names":["textToReplace"]}
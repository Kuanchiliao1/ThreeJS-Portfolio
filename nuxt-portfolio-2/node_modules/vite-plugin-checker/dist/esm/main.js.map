{"version":3,"sources":["../../src/main.ts"],"sourcesContent":["import chalk from 'chalk'\nimport { spawn } from 'child_process'\nimport pick from 'lodash.pick'\nimport npmRunPath from 'npm-run-path'\nimport path from 'path'\nimport type { ConfigEnv, Plugin, ResolvedConfig } from 'vite'\nimport { Checker } from './Checker.js'\nimport { RUNTIME_PUBLIC_PATH, runtimeCode, WS_CHECKER_RECONNECT_EVENT } from './client/index.js'\nimport {\n  ACTION_TYPES,\n  BuildCheckBinStr,\n  BuildInCheckerNames,\n  OverlayErrorAction,\n  PluginConfig,\n  ServeAndBuildChecker,\n  SharedConfig,\n  UserPluginConfig,\n} from './types.js'\n\nconst sharedConfigKeys: (keyof SharedConfig)[] = ['enableBuild', 'overlay']\nconst buildInCheckerKeys: BuildInCheckerNames[] = [\n  'typescript',\n  'vueTsc',\n  'vls',\n  'eslint',\n  'stylelint',\n]\n\nasync function createCheckers(\n  userConfig: UserPluginConfig,\n  env: ConfigEnv\n): Promise<ServeAndBuildChecker[]> {\n  const serveAndBuildCheckers: ServeAndBuildChecker[] = []\n  const sharedConfig = pick(userConfig, sharedConfigKeys)\n\n  // buildInCheckerKeys.forEach(async (name: BuildInCheckerNames) => {\n  for (const name of buildInCheckerKeys) {\n    if (!userConfig[name]) continue\n    const { createServeAndBuild } = await import(`./checkers/${name}/main.js`)\n    serveAndBuildCheckers.push(\n      createServeAndBuild({ [name]: userConfig[name], ...sharedConfig }, env)\n    )\n  }\n\n  return serveAndBuildCheckers\n}\n\nexport function checker(userConfig: UserPluginConfig): Plugin {\n  const enableBuild = userConfig?.enableBuild ?? true\n  const enableOverlay = userConfig?.overlay !== false\n  const enableTerminal = userConfig?.terminal !== false\n  const overlayConfig = typeof userConfig?.overlay === 'object' ? userConfig?.overlay : {}\n  let resolvedRuntimePath = RUNTIME_PUBLIC_PATH\n  let checkers: ServeAndBuildChecker[] = []\n\n  let viteMode: ConfigEnv['command'] | undefined\n  let resolvedConfig: ResolvedConfig | undefined\n\n  return {\n    name: 'vite-plugin-checker',\n    // @ts-ignore\n    __internal__checker: Checker,\n    config: async (config, env) => {\n      // for dev mode (1/2)\n      // Initialize checker with config\n      viteMode = env.command\n\n      checkers = await createCheckers(userConfig || {}, env)\n      if (viteMode !== 'serve') return\n\n      checkers.forEach((checker) => {\n        const workerConfig = checker.serve.config\n        workerConfig({\n          enableOverlay,\n          enableTerminal,\n          env,\n        })\n      })\n    },\n    configResolved(config) {\n      resolvedConfig = config\n      resolvedRuntimePath = config.base + RUNTIME_PUBLIC_PATH.slice(1)\n    },\n    buildEnd() {\n      if (viteMode === 'serve') {\n        checkers.forEach((checker) => {\n          const { worker } = checker.serve\n          worker.terminate()\n        })\n      }\n    },\n    resolveId(id) {\n      if (viteMode === 'serve') {\n        if (id === RUNTIME_PUBLIC_PATH) {\n          return id\n        }\n      }\n\n      return\n    },\n    load(id) {\n      if (viteMode === 'serve') {\n        if (id === RUNTIME_PUBLIC_PATH) {\n          return runtimeCode\n        }\n      }\n\n      return\n    },\n    transform(code, id, options) {\n      if (id === RUNTIME_PUBLIC_PATH) {\n        if (!resolvedConfig) return\n\n        const devBase = resolvedConfig.base\n\n        // #region\n        // copied from https://github.com/vitejs/vite/blob/d76db0cae645beaecd970d95b4819158c5dd568a/packages/vite/src/client/client.ts#LL25\n        const hmrConfig = isObject(resolvedConfig.server.hmr) ? resolvedConfig.server.hmr : {}\n        const host = hmrConfig.host || null\n        const protocol = hmrConfig.protocol || null\n        // hmr.clientPort -> hmr.port\n        // -> (24678 if middleware mode) -> new URL(import.meta.url).port\n        let port = hmrConfig?.clientPort || hmrConfig?.port || null\n        if (resolvedConfig.server.middlewareMode) {\n          port ||= 24678\n        }\n\n        let hmrBase = devBase\n        if (hmrConfig?.path) {\n          hmrBase = path.posix.join(hmrBase, hmrConfig.path)\n        }\n\n        return code\n          .replace(/__HMR_PROTOCOL__/g, JSON.stringify(protocol))\n          .replace(/__HMR_HOSTNAME__/g, JSON.stringify(host))\n          .replace(/__HMR_PORT__/g, JSON.stringify(port))\n          .replace(/__HMR_BASE__/g, JSON.stringify(hmrBase))\n        // #endregion\n      }\n\n      return null\n    },\n    transformIndexHtml() {\n      if (viteMode === 'serve') {\n        return [\n          {\n            tag: 'script',\n            attrs: { type: 'module' },\n            children: `import { inject } from \"${resolvedRuntimePath}\";\ninject({\n  overlayConfig: ${JSON.stringify(overlayConfig)},\n  base: \"${resolvedConfig?.base}\",\n});`,\n          },\n        ]\n      }\n\n      return\n    },\n    buildStart: () => {\n      // only run in build mode\n      // run a bin command in a separated process\n      if (viteMode !== 'build' || !enableBuild) return\n\n      const localEnv = npmRunPath.env({\n        env: process.env,\n        cwd: process.cwd(),\n        execPath: process.execPath,\n      })\n\n      // spawn an async runner that we don't wait for in order to avoid blocking the build from continuing in parallel\n      ;(async () => {\n        const exitCodes = await Promise.all(\n          checkers.map((checker) => spawnChecker(checker, userConfig, localEnv))\n        )\n        const exitCode = exitCodes.find((code) => code !== 0) ?? 0\n        // do not exit the process if run `vite build --watch`\n        if (exitCode !== 0 && !resolvedConfig?.build.watch) {\n          process.exit(exitCode)\n        }\n      })()\n    },\n    configureServer(server) {\n      let connectedTimes = 0\n      let latestOverlayErrors: OverlayErrorAction['payload'][] = new Array(checkers.length)\n      // for dev mode (2/2)\n      // Get the server instance and keep reference in a closure\n      checkers.forEach((checker, index) => {\n        const { worker, configureServer: workerConfigureServer } = checker.serve\n        workerConfigureServer({ root: server.config.root })\n        worker.on('message', (action: OverlayErrorAction) => {\n          if (action.type === ACTION_TYPES.overlayError) {\n            latestOverlayErrors[index] = action.payload\n            if (action.payload) {\n              server.ws.send(action.payload)\n            }\n          } else if (action.type === ACTION_TYPES.console) {\n            Checker.log(action)\n          }\n        })\n      })\n\n      return () => {\n        if (server.ws.on) {\n          // sometimes Vite will trigger a full-reload instead of HMR, but the checker\n          // may update the overlay before full-reload fired. So we make sure the overlay\n          // will be displayed again after full-reload.\n          server.ws.on('connection', () => {\n            connectedTimes++\n            // if connectedCount !== 1, means Vite is doing a full-reload, so we don't need to send overlay again\n            if (connectedTimes > 1) {\n              server.ws.send({\n                type: 'custom',\n                event: WS_CHECKER_RECONNECT_EVENT,\n                data: latestOverlayErrors.filter(Boolean),\n              })\n            }\n          })\n        } else {\n          setTimeout(() => {\n            console.warn(\n              chalk.yellow(\n                \"[vite-plugin-checker]: `server.ws.on` is introduced to Vite in 2.6.8, see [PR](https://github.com/vitejs/vite/pull/5273) and [changelog](https://github.com/vitejs/vite/blob/main/packages/vite/CHANGELOG.md#268-2021-10-18). \\nvite-plugin-checker relies on `server.ws.on` to bring diagnostics back after a full reload and it' not available for you now due to the old version of Vite. You can upgrade Vite to latest version to eliminate this warning.\"\n              )\n            )\n            // make a delay to avoid flush by Vite's console\n          }, 5000)\n        }\n\n        server.middlewares.use((req, res, next) => {\n          next()\n        })\n      }\n    },\n  }\n}\n\nfunction spawnChecker(\n  checker: ServeAndBuildChecker,\n  userConfig: Partial<PluginConfig>,\n  localEnv: npmRunPath.ProcessEnv\n) {\n  return new Promise<number>((resolve) => {\n    const buildBin = checker.build.buildBin\n    const finalBin: BuildCheckBinStr =\n      typeof buildBin === 'function' ? buildBin(userConfig) : buildBin\n\n    const proc = spawn(...finalBin, {\n      cwd: process.cwd(),\n      stdio: 'inherit',\n      env: localEnv,\n      // shell is necessary on windows to get the process to even start.\n      // Command line args constructed by checkers therefore need to escape double quotes\n      // to have them not striped out by cmd.exe. Using shell on all platforms lets us avoid\n      // having to perform platform-specific logic around escaping quotes since all platform\n      // shells will strip out unescaped double quotes. E.g. shell=false on linux only would\n      // result in escaped quotes not being unescaped.\n      shell: true,\n    })\n\n    proc.on('exit', (code) => {\n      if (code !== null && code !== 0) {\n        resolve(code)\n      } else {\n        resolve(0)\n      }\n    })\n  })\n}\n\nfunction isObject(value: unknown): value is Record<string, any> {\n  return Object.prototype.toString.call(value) === '[object Object]'\n}\n\nexport default checker\n"],"mappings":"AAAA,OAAO,WAAW;AAClB,SAAS,aAAa;AACtB,OAAO,UAAU;AACjB,OAAO,gBAAgB;AACvB,OAAO,UAAU;AAEjB,SAAS,eAAe;AACxB,SAAS,qBAAqB,aAAa,kCAAkC;AAC7E;AAAA,EACE;AAAA,OAQK;AAEP,MAAM,mBAA2C,CAAC,eAAe,SAAS;AAC1E,MAAM,qBAA4C;AAAA,EAChD;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEA,eAAe,eACb,YACA,KACiC;AACjC,QAAM,wBAAgD,CAAC;AACvD,QAAM,eAAe,KAAK,YAAY,gBAAgB;AAGtD,aAAW,QAAQ,oBAAoB;AACrC,QAAI,CAAC,WAAW;AAAO;AACvB,UAAM,EAAE,oBAAoB,IAAI,MAAM,OAAO,cAAc;AAC3D,0BAAsB;AAAA,MACpB,oBAAoB,EAAE,CAAC,OAAO,WAAW,OAAO,GAAG,aAAa,GAAG,GAAG;AAAA,IACxE;AAAA,EACF;AAEA,SAAO;AACT;AAEO,SAAS,QAAQ,YAAsC;AAC5D,QAAM,eAAc,yCAAY,gBAAe;AAC/C,QAAM,iBAAgB,yCAAY,aAAY;AAC9C,QAAM,kBAAiB,yCAAY,cAAa;AAChD,QAAM,gBAAgB,QAAO,yCAAY,aAAY,WAAW,yCAAY,UAAU,CAAC;AACvF,MAAI,sBAAsB;AAC1B,MAAI,WAAmC,CAAC;AAExC,MAAI;AACJ,MAAI;AAEJ,SAAO;AAAA,IACL,MAAM;AAAA,IAEN,qBAAqB;AAAA,IACrB,QAAQ,OAAO,QAAQ,QAAQ;AAG7B,iBAAW,IAAI;AAEf,iBAAW,MAAM,eAAe,cAAc,CAAC,GAAG,GAAG;AACrD,UAAI,aAAa;AAAS;AAE1B,eAAS,QAAQ,CAACA,aAAY;AAC5B,cAAM,eAAeA,SAAQ,MAAM;AACnC,qBAAa;AAAA,UACX;AAAA,UACA;AAAA,UACA;AAAA,QACF,CAAC;AAAA,MACH,CAAC;AAAA,IACH;AAAA,IACA,eAAe,QAAQ;AACrB,uBAAiB;AACjB,4BAAsB,OAAO,OAAO,oBAAoB,MAAM,CAAC;AAAA,IACjE;AAAA,IACA,WAAW;AACT,UAAI,aAAa,SAAS;AACxB,iBAAS,QAAQ,CAACA,aAAY;AAC5B,gBAAM,EAAE,OAAO,IAAIA,SAAQ;AAC3B,iBAAO,UAAU;AAAA,QACnB,CAAC;AAAA,MACH;AAAA,IACF;AAAA,IACA,UAAU,IAAI;AACZ,UAAI,aAAa,SAAS;AACxB,YAAI,OAAO,qBAAqB;AAC9B,iBAAO;AAAA,QACT;AAAA,MACF;AAEA;AAAA,IACF;AAAA,IACA,KAAK,IAAI;AACP,UAAI,aAAa,SAAS;AACxB,YAAI,OAAO,qBAAqB;AAC9B,iBAAO;AAAA,QACT;AAAA,MACF;AAEA;AAAA,IACF;AAAA,IACA,UAAU,MAAM,IAAI,SAAS;AAC3B,UAAI,OAAO,qBAAqB;AAC9B,YAAI,CAAC;AAAgB;AAErB,cAAM,UAAU,eAAe;AAI/B,cAAM,YAAY,SAAS,eAAe,OAAO,GAAG,IAAI,eAAe,OAAO,MAAM,CAAC;AACrF,cAAM,OAAO,UAAU,QAAQ;AAC/B,cAAM,WAAW,UAAU,YAAY;AAGvC,YAAI,QAAO,uCAAW,gBAAc,uCAAW,SAAQ;AACvD,YAAI,eAAe,OAAO,gBAAgB;AACxC,0BAAS;AAAA,QACX;AAEA,YAAI,UAAU;AACd,YAAI,uCAAW,MAAM;AACnB,oBAAU,KAAK,MAAM,KAAK,SAAS,UAAU,IAAI;AAAA,QACnD;AAEA,eAAO,KACJ,QAAQ,qBAAqB,KAAK,UAAU,QAAQ,CAAC,EACrD,QAAQ,qBAAqB,KAAK,UAAU,IAAI,CAAC,EACjD,QAAQ,iBAAiB,KAAK,UAAU,IAAI,CAAC,EAC7C,QAAQ,iBAAiB,KAAK,UAAU,OAAO,CAAC;AAAA,MAErD;AAEA,aAAO;AAAA,IACT;AAAA,IACA,qBAAqB;AACnB,UAAI,aAAa,SAAS;AACxB,eAAO;AAAA,UACL;AAAA,YACE,KAAK;AAAA,YACL,OAAO,EAAE,MAAM,SAAS;AAAA,YACxB,UAAU,2BAA2B;AAAA;AAAA,mBAE9B,KAAK,UAAU,aAAa;AAAA,WACpC,iDAAgB;AAAA;AAAA,UAEjB;AAAA,QACF;AAAA,MACF;AAEA;AAAA,IACF;AAAA,IACA,YAAY,MAAM;AAGhB,UAAI,aAAa,WAAW,CAAC;AAAa;AAE1C,YAAM,WAAW,WAAW,IAAI;AAAA,QAC9B,KAAK,QAAQ;AAAA,QACb,KAAK,QAAQ,IAAI;AAAA,QACjB,UAAU,QAAQ;AAAA,MACpB,CAAC;AAGA,OAAC,YAAY;AACZ,cAAM,YAAY,MAAM,QAAQ;AAAA,UAC9B,SAAS,IAAI,CAACA,aAAY,aAAaA,UAAS,YAAY,QAAQ,CAAC;AAAA,QACvE;AACA,cAAM,WAAW,UAAU,KAAK,CAAC,SAAS,SAAS,CAAC,KAAK;AAEzD,YAAI,aAAa,KAAK,EAAC,iDAAgB,MAAM,QAAO;AAClD,kBAAQ,KAAK,QAAQ;AAAA,QACvB;AAAA,MACF,GAAG;AAAA,IACL;AAAA,IACA,gBAAgB,QAAQ;AACtB,UAAI,iBAAiB;AACrB,UAAI,sBAAuD,IAAI,MAAM,SAAS,MAAM;AAGpF,eAAS,QAAQ,CAACA,UAAS,UAAU;AACnC,cAAM,EAAE,QAAQ,iBAAiB,sBAAsB,IAAIA,SAAQ;AACnE,8BAAsB,EAAE,MAAM,OAAO,OAAO,KAAK,CAAC;AAClD,eAAO,GAAG,WAAW,CAAC,WAA+B;AACnD,cAAI,OAAO,SAAS,aAAa,cAAc;AAC7C,gCAAoB,SAAS,OAAO;AACpC,gBAAI,OAAO,SAAS;AAClB,qBAAO,GAAG,KAAK,OAAO,OAAO;AAAA,YAC/B;AAAA,UACF,WAAW,OAAO,SAAS,aAAa,SAAS;AAC/C,oBAAQ,IAAI,MAAM;AAAA,UACpB;AAAA,QACF,CAAC;AAAA,MACH,CAAC;AAED,aAAO,MAAM;AACX,YAAI,OAAO,GAAG,IAAI;AAIhB,iBAAO,GAAG,GAAG,cAAc,MAAM;AAC/B;AAEA,gBAAI,iBAAiB,GAAG;AACtB,qBAAO,GAAG,KAAK;AAAA,gBACb,MAAM;AAAA,gBACN,OAAO;AAAA,gBACP,MAAM,oBAAoB,OAAO,OAAO;AAAA,cAC1C,CAAC;AAAA,YACH;AAAA,UACF,CAAC;AAAA,QACH,OAAO;AACL,qBAAW,MAAM;AACf,oBAAQ;AAAA,cACN,MAAM;AAAA,gBACJ;AAAA,cACF;AAAA,YACF;AAAA,UAEF,GAAG,GAAI;AAAA,QACT;AAEA,eAAO,YAAY,IAAI,CAAC,KAAK,KAAK,SAAS;AACzC,eAAK;AAAA,QACP,CAAC;AAAA,MACH;AAAA,IACF;AAAA,EACF;AACF;AAEA,SAAS,aACPA,UACA,YACA,UACA;AACA,SAAO,IAAI,QAAgB,CAAC,YAAY;AACtC,UAAM,WAAWA,SAAQ,MAAM;AAC/B,UAAM,WACJ,OAAO,aAAa,aAAa,SAAS,UAAU,IAAI;AAE1D,UAAM,OAAO,MAAM,GAAG,UAAU;AAAA,MAC9B,KAAK,QAAQ,IAAI;AAAA,MACjB,OAAO;AAAA,MACP,KAAK;AAAA,MAOL,OAAO;AAAA,IACT,CAAC;AAED,SAAK,GAAG,QAAQ,CAAC,SAAS;AACxB,UAAI,SAAS,QAAQ,SAAS,GAAG;AAC/B,gBAAQ,IAAI;AAAA,MACd,OAAO;AACL,gBAAQ,CAAC;AAAA,MACX;AAAA,IACF,CAAC;AAAA,EACH,CAAC;AACH;AAEA,SAAS,SAAS,OAA8C;AAC9D,SAAO,OAAO,UAAU,SAAS,KAAK,KAAK,MAAM;AACnD;AAEA,IAAO,eAAQ;","names":["checker"]}